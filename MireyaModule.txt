local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Cargar m√≥dulos con validaci√≥n
local VidaManager, EquipoManager, EstadoManager

if RunService:IsServer() then
	local success1, vm = pcall(function() return require(game.ServerScriptService:WaitForChild("VidaManager")) end)
	local success2, em = pcall(function() return require(game.ReplicatedStorage:WaitForChild("EquipoManager")) end)
	local success3, sm = pcall(function() return require(game.ServerScriptService:WaitForChild("EstadoManager")) end)

	VidaManager = success1 and vm or nil
	EquipoManager = success2 and em or nil
	EstadoManager = success3 and sm or nil
end

local MireyaSkills = {}

-- Funci√≥n auxiliar para obtener el origen de habilidades (Mireya o aliado fusionado)
local function obtenerOrigenHabilidad(character)
	local aliadoFusionado = character:FindFirstChild("AliadoFusionado")
	if aliadoFusionado and aliadoFusionado.Value and aliadoFusionado.Value.Parent then
		local aliado = aliadoFusionado.Value
		local hrpAliado = aliado:FindFirstChild("HumanoidRootPart")
		if hrpAliado then
			return hrpAliado
		end
	end
	-- Si no est√° fusionado, usar el propio HRP de Mireya
	return character:FindFirstChild("HumanoidRootPart")
end

-- Habilidad 1: Onda Vital (Modificada para usar origen de fusi√≥n)
MireyaSkills["1"] = {
	Nombre = "Onda Vital",
	Descripcion = "Lanza un proyectil curativo que cura a los aliados y da√±a a los enemigos que atraviesa.",
	Cooldown = 8,
	Tipo = "Direccion",
	Execute = function(character, direccion, nivelHabilidad)
		local nivel = nivelHabilidad or 1
		local player = Players:GetPlayerFromCharacter(character)
		if not player then
			print("[Onda Vital] Error: No se pudo obtener el jugador")
			return false
		end

		if not character or not character.Parent then
			print("‚ùå Personaje no disponible")
			return false
		end

		-- Obtener el origen correcto (Mireya o aliado fusionado)
		local hrp = obtenerOrigenHabilidad(character)
		if not hrp then
			local maxWaitTime = 2
			local startTime = time()
			while not hrp and (time() - startTime) < maxWaitTime do
				task.wait(0.1)
				hrp = obtenerOrigenHabilidad(character)
			end
			if not hrp then
				warn("‚ùå No se encontr√≥ HumanoidRootPart despu√©s de esperar")
				return false
			end
		end

		print("[MireyaSkills][Onda Vital] Activada por:", player.Name, "Nivel:", nivel)

		-- Direcci√≥n del proyectil
		local dir = direccion or hrp.CFrame.LookVector
		local origen = hrp.Position + dir * 3

		-- Evento para efectos visuales (SOLO para el proyectil)
		local ondaVitalEvent = game.ReplicatedStorage:FindFirstChild("MireyaOndaVitalEvent")
		if ondaVitalEvent then
			ondaVitalEvent:FireAllClients(origen, dir, nivel)
		else
			warn("‚ùå No se encontr√≥ MireyaOndaVitalEvent")
		end

		-- Crear proyectil F√çSICO (invisible) solo en servidor
		local estela = Instance.new("Part")
		estela.Size = Vector3.new(2, 2, 2)
		estela.Transparency = 1  -- Invisible
		estela.CanCollide = false
		estela.Anchored = false
		estela.Position = origen
		estela.Parent = workspace

		-- üîä AGREGAR SONIDO A LA ESTELA F√çSICA
		print("üîä Agregando sonido a la estela f√≠sica...")
		local sonidoEstela = Instance.new("Sound")
		sonidoEstela.SoundId = "rbxassetid://121876820271865"
		sonidoEstela.Volume = 0.8
		sonidoEstela.MaxDistance = 80
		sonidoEstela.RollOffMinDistance = 10
		sonidoEstela.RollOffMaxDistance = 80
		sonidoEstela.Looped = true  -- Para que se repita mientras viaja
		sonidoEstela.Parent = estela
		sonidoEstela:Play()
		print("üîä Sonido de estela reproducido - ID: " .. sonidoEstela.SoundId)

		-- Movimiento (velocidad aumenta con nivel)
		local velocidad = 50 + nivel * 5
		local bodyVelocity = Instance.new("BodyVelocity")
		bodyVelocity.Velocity = dir * velocidad
		bodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
		bodyVelocity.Parent = estela

		local aliadosCurados = {}

		-- Colisiones
		local touchedConnection
		touchedConnection = estela.Touched:Connect(function(hit)
			if not estela or not estela.Parent then
				if touchedConnection then touchedConnection:Disconnect() end
				return
			end

			local modelo = hit:FindFirstAncestorOfClass("Model")
			if not modelo then return end

			local humanoide = modelo:FindFirstChildOfClass("Humanoid")
			if not humanoide or humanoide.Health <= 0 then return end

			-- Verificar aliado o enemigo
			if EquipoManager then
				if not EquipoManager.SonEnemigos(character, modelo) then
					-- ‚úÖ Aliado ‚Üí curar (m√°s curaci√≥n con nivel)
					if not aliadosCurados[modelo] then
						aliadosCurados[modelo] = true

						local curacion = 25 + nivel * 5
						local vidaAntes = humanoide.Health
						humanoide.Health = math.min(humanoide.MaxHealth, humanoide.Health + curacion)
						print("üíö Onda Vital cur√≥ a: " .. modelo.Name .. " " .. vidaAntes .. " ‚Üí " .. humanoide.Health .. " HP (+" .. curacion .. ")")

						-- Evento para efectos de curaci√≥n
						if ondaVitalEvent then
							ondaVitalEvent:FireAllClients("Curacion", modelo, humanoide.Health, nivel)
						end
					end
				else
					-- ‚úÖ Enemigo ‚Üí da√±ar (m√°s da√±o con nivel)
					if not aliadosCurados[modelo] then
						aliadosCurados[modelo] = true

						local danio = 15 + nivel * 3
						local ok, err = pcall(function()
							if VidaManager then
								VidaManager:AplicarDanio(character, modelo, danio)
							else
								humanoide:TakeDamage(danio)
							end
						end)
						if ok then
							print("üí• Onda Vital da√±√≥ a:", modelo.Name, "por", danio, "HP")
						else
							warn("[Onda Vital] Error al aplicar da√±o:", err)
						end

						-- Evento para efectos de da√±o
						if ondaVitalEvent then
							ondaVitalEvent:FireAllClients("Dano", modelo, humanoide.Health, nivel)
						end
					end
				end
			else
				print("[Onda Vital] No hay EquipoManager, no se pudo verificar aliado/enemigo")
			end

			-- Colisi√≥n con terreno o parte anclada
			if hit:IsA("Part") and (hit.Anchored or hit.Parent:IsA("Terrain")) then
				-- üîá Detener sonido al colisionar
				if sonidoEstela then
					sonidoEstela:Stop()
				end
				if bodyVelocity then bodyVelocity:Destroy() end
				if estela then estela:Destroy() end
				if touchedConnection then touchedConnection:Disconnect() end
			end
		end)

		-- Destrucci√≥n por tiempo/distancia (m√°s duraci√≥n con nivel)
		local distanciaMaxima, tiempoInicio = 100 + nivel * 10, time()
		local conexion
		conexion = game:GetService("RunService").Heartbeat:Connect(function()
			if not estela or not estela.Parent then
				if conexion then conexion:Disconnect() end
				return
			end

			if time() - tiempoInicio > (4 + nivel * 0.5) or (estela.Position - hrp.Position).Magnitude > distanciaMaxima then
				-- üîá Detener sonido al destruir
				if sonidoEstela then
					sonidoEstela:Stop()
				end
				if conexion then conexion:Disconnect() end
				if touchedConnection then touchedConnection:Disconnect() end
				estela:Destroy()
			end
		end)

		return true
	end
}

-- Habilidad 2: Semilla de Renovaci√≥n (Actualizada con niveles)
-- Habilidad 2: Semilla de Renovaci√≥n (Mejorada con efectos visuales y sonidos)
MireyaSkills["2"] = {
	Nombre = "Semilla de Renovaci√≥n",
	Descripcion = "Coloca una semilla m√°gica en un aliado que florece despu√©s de 2 segundos, curando o explotando en √°rea si el aliado muere.",
	Cooldown = 14,
	Tipo = "Seleccion",
	RequiereAliado = true,
	Execute = function(character, target, nivelHabilidad)
		local nivel = nivelHabilidad or 1
		print("[SemillaRenovacion] üå± EJECUTANDO - Iniciando Nivel:", nivel)

		local player = Players:GetPlayerFromCharacter(character)
		if not player then
			print("[SemillaRenovacion] ‚ùå Error: No se pudo obtener el jugador")
			return false
		end

		if not target or not target.Parent then
			print("[SemillaRenovacion] ‚ùå Error: Objetivo nulo o sin parent")
			return false
		end

		local objetivoHrp = target:FindFirstChild("HumanoidRootPart")
		if not objetivoHrp then
			print("[SemillaRenovacion] ‚ùå Error: Objetivo no tiene HRP")
			return false
		end

		-- Verificar si es aliado
		if EquipoManager and EquipoManager.SonEnemigos(character, target) then
			print("[SemillaRenovacion] ‚ùå No se puede colocar semilla en enemigos")
			return false
		end

		print("[SemillaRenovacion] ‚úÖ Objetivo v√°lido:", target.Name)

		-- üîä SONIDO: Aplicaci√≥n de semilla
		local sonidoAplicacion = Instance.new("Sound")
		sonidoAplicacion.SoundId = "rbxassetid://95101113086995" -- Sonido m√°gico suave
		sonidoAplicacion.Volume = 0.6
		sonidoAplicacion.Parent = objetivoHrp
		sonidoAplicacion:Play()
		game:GetService("Debris"):AddItem(sonidoAplicacion, 3)

		-- Activar efecto visual en cliente
		local semillaEvent = game.ReplicatedStorage:FindFirstChild("MireyaSemillaRenovacionEvent")
		if semillaEvent then
			print("[SemillaRenovacion] üì® Enviando evento al cliente")
			semillaEvent:FireAllClients(target, objetivoHrp.Position, "Aplicar", nivel)
		end

		-- Crear marcador de semilla
		local semillaMarker = Instance.new("ObjectValue")
		semillaMarker.Name = "SemillaRenovacion"
		semillaMarker.Value = character
		semillaMarker.Parent = target

		-- Configuraci√≥n seg√∫n nivel
		local configPorNivel = {
			curacionBase = 60 + nivel * 10,
			curacionArea = 30 + nivel * 5,
			radioArea = 10 + nivel * 2,
			duracion = 2 + nivel * 0.3  -- M√°s duraci√≥n con nivel
		}

		print("[SemillaRenovacion] üìä Configuraci√≥n - Curaci√≥n:", configPorNivel.curacionBase, "√Årea:", configPorNivel.curacionArea)

		-- Esperar para que florezca
		task.delay(configPorNivel.duracion, function()
			if target and target.Parent and semillaMarker and semillaMarker.Parent then
				print("[SemillaRenovacion] üå∏ Procesando florecimiento en:", target.Name)

				local humanoideObjetivo = target:FindFirstChildOfClass("Humanoid")
				if humanoideObjetivo and humanoideObjetivo.Health > 0 then
					-- Curaci√≥n principal
					local vidaAntes = humanoideObjetivo.Health
					humanoideObjetivo.Health = math.min(humanoideObjetivo.MaxHealth, humanoideObjetivo.Health + configPorNivel.curacionBase)

					print("üå± Semilla de Renovaci√≥n floreci√≥ en: " .. target.Name .. " " .. vidaAntes .. " ‚Üí " .. humanoideObjetivo.Health .. " HP (+" .. configPorNivel.curacionBase .. ")")

					-- üîä SONIDO: Florecimiento
					local sonidoFlorecimiento = Instance.new("Sound")
					sonidoFlorecimiento.SoundId = "rbxassetid://93523325820244" -- Sonido de florecimiento
					sonidoFlorecimiento.Volume = 0.8
					sonidoFlorecimiento.Parent = objetivoHrp
					sonidoFlorecimiento:Play()
					game:GetService("Debris"):AddItem(sonidoFlorecimiento, 3)

					-- Efecto visual de florecimiento
					if semillaEvent then
						semillaEvent:FireAllClients("Florecer", target, objetivoHrp.Position, nivel)
					end
				else
					print("[SemillaRenovacion] üíÄ Objetivo muerto, aplicando curaci√≥n en √°rea")

					-- üîä SONIDO: Explosi√≥n de semilla
					local sonidoExplosion = Instance.new("Sound")
					sonidoExplosion.SoundId = "rbxassetid://121421139153134" -- Sonido de explosi√≥n m√°gica
					sonidoExplosion.Volume = 1.0
					sonidoExplosion.Parent = objetivoHrp
					sonidoExplosion:Play()
					game:GetService("Debris"):AddItem(sonidoExplosion, 3)

					-- Curaci√≥n en √°rea
					local curados = 0
					for _, obj in ipairs(workspace:GetChildren()) do
						if obj:IsA("Model") and obj ~= target then
							local objHrp = obj:FindFirstChild("HumanoidRootPart")
							if objHrp then
								local distancia = (objHrp.Position - objetivoHrp.Position).Magnitude
								if distancia <= configPorNivel.radioArea then
									if not EquipoManager or not EquipoManager.SonEnemigos(character, obj) then
										local humanoideObj = obj:FindFirstChildOfClass("Humanoid")
										if humanoideObj and humanoideObj.Health > 0 then
											local vidaAntes = humanoideObj.Health
											humanoideObj.Health = math.min(humanoideObj.MaxHealth, humanoideObj.Health + configPorNivel.curacionArea)
											print("üí• Semilla explot√≥ curando a: " .. obj.Name .. " " .. vidaAntes .. " ‚Üí " .. humanoideObj.Health .. " HP (+" .. configPorNivel.curacionArea .. ")")
											curados = curados + 1
										end
									end
								end
							end
						end
					end

					print("[SemillaRenovacion] üåê Curaci√≥n en √°rea aplicada a " .. curados .. " objetivos")

					-- Efecto visual de explosi√≥n
					if semillaEvent then
						semillaEvent:FireAllClients("Explotar", target, objetivoHrp.Position, nivel)
					end
				end

				-- Eliminar marcador
				semillaMarker:Destroy()
			else
				print("[SemillaRenovacion] ‚ùå Error: Target o marcador no existen despu√©s del delay")
			end
		end)

		return true
	end
}

-- Habilidad 3: Lazos de la Fe (Actualizada con niveles)
MireyaSkills["3"] = {
	Name = "Lazos de la Fe",
	Descripcion = "Crea un v√≠nculo con an aliado, compartiendo curaci√≥n y da√±o.",
	Cooldown = 20,
	Tipo = "Seleccion",
	RequiereAliado = true,
	Execute = function(character, target, nivelHabilidad)
		local nivel = nivelHabilidad or 1
		local player = Players:GetPlayerFromCharacter(character)
		if not player then return false end

		print("[MireyaSkills][Lazos de la Fe] Activada por:", player.Name, "Nivel:", nivel)

		-- Obtener el origen correcto
		local hrp = obtenerOrigenHabilidad(character)
		if not hrp or not target or target == character then return false end

		-- Verificar si es aliado
		if EquipoManager and EquipoManager.SonEnemigos(character, target) then
			print("‚ùå No se puede crear lazo con enemigos")
			return false
		end

		local objetivoHrp = target:FindFirstChild("HumanoidRootPart")
		if not objetivoHrp then return false end

		-- ‚úÖ CORREGIDO: Pasar "Conectar" como primer par√°metro
		local lazosEvent = game.ReplicatedStorage:FindFirstChild("MireyaLazosFeEvent")
		if lazosEvent then
			lazosEvent:FireAllClients("Conectar", character, target, nivel)
		end

		-- Crear v√≠nculo
		local duracion = 8 + nivel * 1
		local porcentajeTransferencia = 0.3 + (nivel * 0.05)

		-- Marcadores para ambos personajes
		local vinculoMireya = Instance.new("ObjectValue")
		vinculoMireya.Name = "VinculoLazoFe"
		vinculoMireya.Value = target
		vinculoMireya.Parent = character

		local vinculoObjetivo = Instance.new("ObjectValue")
		vinculoObjetivo.Name = "VinculoLazoFe"
		vinculoObjetivo.Value = character
		vinculoObjetivo.Parent = target

		-- Funci√≥n para manejar la transferencia (tu c√≥digo existente)
		local function manejarTransferencia(personajeDanado, cantidad, esCuracion)
			-- ... (mant√©n tu c√≥digo existente aqu√≠)
		end

		print("üîó Lazo de Fe creado entre " .. character.Name .. " y " .. target.Name)

		-- Eliminar v√≠nculo despu√©s de la duraci√≥n
		task.delay(duracion, function()
			if vinculoMireya and vinculoMireya.Parent then
				vinculoMireya:Destroy()
			end
			if vinculoObjetivo and vinculoObjetivo.Parent then
				vinculoObjetivo:Destroy()
			end

			-- ‚úÖ CORREGIDO: Pasar "Desconectar" como primer par√°metro
			if lazosEvent then
				lazosEvent:FireAllClients("Desconectar", character, target)
			end

			print("üîó Lazo de Fe finalizado")
		end)

		return true
	end
}

-- Habilidad 4: Fusi√≥n Sagrada (Ultimate) (Actualizada con niveles)
MireyaSkills["4"] = {
	Name = "Fusi√≥n Sagrada",
	Descripcion = "Se fusiona con un aliado, protegi√©ndolo con un escudo y transfiriendo sus alas. La c√°mara se transfiere al aliado durante la duraci√≥n.",
	Cooldown = 80,
	Tipo = "Seleccion",
	RequiereAliado = true,
	Execute = function(character, target, nivelHabilidad)
		local nivel = nivelHabilidad or 1
		-- Obtener el jugador desde el character
		local player = Players:GetPlayerFromCharacter(character)
		if not player then
			return false
		end

		print("[MireyaSkills][Fusi√≥n Sagrada] Activada por:", player.Name, "Nivel:", nivel)

		local hrp = character:FindFirstChild("HumanoidRootPart")
		if not hrp or not target or target == character then return false end

		-- Verificar si es aliado
		if EquipoManager and EquipoManager.SonEnemigos(character, target) then
			print("‚ùå No se puede fusionar con enemigos")
			return false
		end

		local objetivoHrp = target:FindFirstChild("HumanoidRootPart")
		if not objetivoHrp then return false end

		-- Buscar el accesorio de alas en Mireya
		local alasOriginales = character:FindFirstChild("ribbon wings")
		if not alasOriginales then
			print("‚ùå No se encontraron alas en Mireya")
			return false
		end

		-- Activar efecto visual en cliente (incluyendo informaci√≥n de c√°mara)
		local fusionEvent = game.ReplicatedStorage:FindFirstChild("MireyaFusionSagradaEvent")
		if fusionEvent then
			-- Enviamos un par√°metro adicional para indicar que es para el jugador local
			fusionEvent:FireAllClients("Crear", character, target, nivel, player.UserId)
		end

		-- Configurar fusi√≥n (m√°s duraci√≥n y escudo con nivel)
		local duracion = 8 + nivel * 1
		local escudoMaximo = 200 + nivel * 40

		-- Crear escudo para el aliado
		local escudo = Instance.new("IntValue")
		escudo.Name = "EscudoFusionSagrada"
		escudo.Value = escudoMaximo
		escudo.Parent = target

		-- Guardar referencia al aliado fusionado
		local aliadoValue = Instance.new("ObjectValue")
		aliadoValue.Name = "AliadoFusionado"
		aliadoValue.Value = target
		aliadoValue.Parent = character


		-- Hacer una copia de las alas
		local alasAliado = alasOriginales:Clone()

		-- Buscar el Handle y el AccessoryWeld
		local handle = alasAliado:FindFirstChild("Handle")
		local accessoryWeld = alasAliado:FindFirstChild("AccessoryWeld")

		if handle and accessoryWeld then
			-- Ajustar el CFrame del AccessoryWeld para colocar las alas en la espalda
			-- Nota: El C0 del AccessoryWeld es relativo a la parte base (HumanoidRootPart o Torso)
			-- Puede que necesites experimentar con los valores para que se vea bien.
			accessoryWeld.C0 = CFrame.new(0, 1, 0) * CFrame.Angles(0, math.rad(180), 0)
		end

		alasAliado.Parent = target

		-- Hacer a Mireya invisible e invulnerable usando EstadoManager
		EstadoManager.AplicarEstado(character, "Invisible", duracion)
		EstadoManager.AplicarEstado(character, "Invulnerable", duracion)
		EstadoManager.AplicarEstado(character, "Inmovilizado", duracion)

		character:SetAttribute("Fusionado", true) -- Marcar que est√° fusionado

		-- Ocultar las alas originales de Mireya
		alasOriginales.Parent = nil

		-- Sistema de absorci√≥n de da√±o
		local humanoideObjetivo = target:FindFirstChildOfClass("Humanoid")
		if humanoideObjetivo then
			local conexionDanio
			conexionDanio = humanoideObjetivo.HealthChanged:Connect(function()
				if escudo.Value > 0 then
					local danio = humanoideObjetivo.MaxHealth - humanoideObjetivo.Health
					if danio > 0 then
						local absorcion = math.min(danio, escudo.Value)
						escudo.Value = escudo.Value - absorcion
						humanoideObjetivo.Health = humanoideObjetivo.Health + absorcion
						print("üõ°Ô∏è Escudo absorbi√≥ " .. absorcion .. " de da√±o. Escudo restante: " .. escudo.Value)

						if escudo.Value <= 0 then
							print("üõ°Ô∏è Escudo agotado")
							conexionDanio:Disconnect()
						end
					end
				end
			end)
		end

		print("‚ú® Fusi√≥n Sagrada activada con " .. target.Name)

		-- Finalizar fusi√≥n despu√©s de la duraci√≥n
		task.delay(duracion, function()
			-- Restaurar a Mireya
			EstadoManager.RemoverEstado(character, "Invisible")
			EstadoManager.RemoverEstado(character, "Invulnerable")
			EstadoManager.RemoverEstado(character, "Inmovilizado")

			character:SetAttribute("Fusionado", false)

			-- Eliminar la referencia al aliado
			local aliadoValue = character:FindFirstChild("AliadoFusionado")
			if aliadoValue then
				aliadoValue:Destroy()
			end

			-- Devolver las alas a Mireya
			if alasAliado and alasAliado.Parent then
				alasAliado:Destroy()
			end
			alasOriginales.Parent = character

			-- Eliminar escudo
			if escudo and escudo.Parent then
				escudo:Destroy()
			end

			-- Desactivar efecto visual y restaurar c√°mara
			if fusionEvent then
				fusionEvent:FireAllClients("Finalizar", character, target, nivel, player.UserId)
			end

			print("‚ú® Fusi√≥n Sagrada finalizada")
		end)

		return true
	end
}

return MireyaSkills
-- ðŸ“ ModuleScript en ServerScriptService
local BasicAttackCooldown = {}

local cooldowns = {}

-- ðŸŽ¯ CONFIGURACIÃ“N DE COOLDOWNS POR PERSONAJE (ACTUALIZADO)
local cooldownTimes = {
	Spartan = 0.8,
	Nythera = 0.6,
	Sonic = 0.5,
	DragonYinYan = 0.7,
	Blacktor = 0.6,
	Zombie = 0.6,
	Mireya = 0.7
	-- Los personajes no listados usarÃ¡n 0.7 por defecto
}

-- ðŸŽ¯ FunciÃ³n para obtener nombre del personaje desde atributo
local function obtenerNombrePersonaje(character)
	if not character then return "Default" end

	-- Primero intentar con el atributo NombrePersonaje
	local nombrePersonaje = character:GetAttribute("NombrePersonaje")
	if nombrePersonaje then
		return nombrePersonaje
	end

	-- Fallback al nombre del modelo
	return character.Name
end

function BasicAttackCooldown.canAttack(character)
	if not character then 
		print("âŒ [Cooldown] Character es nulo")
		return false 
	end

	local characterName = obtenerNombrePersonaje(character)
	local now = os.clock()

	-- ðŸ†• VERIFICACIÃ“N DE ESTADOS QUE BLOQUEAN ATAQUES
	local EstadoManager = require(game.ServerScriptService:WaitForChild("EstadoManager"))

	-- âŒ Si estÃ¡ aturdido, no puede atacar
	if EstadoManager.TieneEstado(character, "Aturdido") then
		print("ðŸŒ€ [Cooldown] " .. characterName .. " estÃ¡ aturdido, ataque bloqueado")
		return false
	end

	-- âŒ Si estÃ¡ bloqueado de ataque, no puede atacar
	if EstadoManager.TieneEstado(character, "BloqueadoAtaque") then
		print("ðŸ›¡ï¸ [Cooldown] " .. characterName .. " estÃ¡ bloqueado, ataque bloqueado")
		return false
	end

	-- âœ… Si no tiene cooldown registrado, puede atacar
	if not cooldowns[characterName] then
		cooldowns[characterName] = now
		print("âœ… [Cooldown] " .. characterName .. " puede atacar (sin cooldown previo)")
		return true
	end

	-- ðŸŽ¯ Verificar si ha pasado el tiempo de cooldown
	local cooldownTime = cooldownTimes[characterName] or 0.7 -- Valor por defecto

	if now - cooldowns[characterName] >= cooldownTime then
		cooldowns[characterName] = now
		print("âœ… [Cooldown] " .. characterName .. " puede atacar (cooldown completado)")
		return true
	end

	-- âŒ TodavÃ­a en cooldown
	local tiempoRestante = cooldownTime - (now - cooldowns[characterName])
	print("â³ [Cooldown] " .. characterName .. " en cooldown: " .. string.format("%.2f", tiempoRestante) .. "s restantes")
	return false
end

-- ðŸ†• FUNCIÃ“N: Obtener tiempo restante de cooldown (para UI)
function BasicAttackCooldown.getCooldownRemaining(character)
	if not character then return 0 end

	local characterName = obtenerNombrePersonaje(character)
	local now = os.clock()

	if not cooldowns[characterName] then
		return 0
	end

	local cooldownTime = cooldownTimes[characterName] or 0.7
	local tiempoRestante = cooldownTime - (now - cooldowns[characterName])

	return math.max(0, tiempoRestante)
end

-- ðŸ†• FUNCIÃ“N: Forzar reset de cooldown (para habilidades)
function BasicAttackCooldown.resetCooldown(character)
	if not character then return end

	local characterName = obtenerNombrePersonaje(character)
	cooldowns[characterName] = nil
	print("ðŸ”„ [Cooldown] Cooldown reseteado para: " .. characterName)
end

-- ðŸ§¹ Limpiar cooldowns cuando un personaje es eliminado
game:GetService("Players").PlayerRemoving:Connect(function(player)
	if player.Character then
		local characterName = obtenerNombrePersonaje(player.Character)
		cooldowns[characterName] = nil
		print("ðŸ§¹ [Cooldown] Cooldown limpiado para: " .. characterName)
	end
end)

-- ðŸ§¹ Limpieza periÃ³dica de cooldowns huÃ©rfanos
task.spawn(function()
	while true do
		task.wait(60) -- Cada minuto
		local now = os.clock()
		local limpiados = 0

		for name, tiempo in pairs(cooldowns) do
			-- Si no se ha usado en 5 minutos, limpiar
			if now - tiempo > 300 then
				cooldowns[name] = nil
				limpiados += 1
			end
		end

		if limpiados > 0 then
			print("ðŸ§¹ [Cooldown] Limpiados " .. limpiados .. " cooldowns huÃ©rfanos")
		end
	end
end)

print("âœ… BasicAttackCooldown cargado - Sistema integrado con estados")
return BasicAttackCooldown
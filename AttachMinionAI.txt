
-- ServerScriptService/AttachMinionAI (Script)
-- Automatically attaches MinionAI to every new minion spawned in Workspace

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MinionAI = require(ReplicatedStorage:WaitForChild("MinionAI"))

-- ğŸ”¥ TABLA PARA RASTREAR MINIONS QUE YA TIENEN AI
local minionsWithAI = {}

local function tryAttachAI(minion)
	-- âœ… VERIFICACIONES MÃšLTIPLES PARA EVITAR DUPLICADOS
	if not minion:IsA("Model") then
		return
	end

	-- Esperar un frame para que los atributos se establezcan
	task.wait(0.1)

	-- Verificar si es un minion y si ya tiene AI
	if minion:GetAttribute("IsMinion") and not minion:GetAttribute("AIStarted") then
		-- ğŸ”¥ VERIFICACIÃ“N ADICIONAL: No procesar si ya estÃ¡ en la tabla
		if minionsWithAI[minion] then
			return
		end

		-- ğŸ”¥ MARCAR PRIMERO ANTES DE INICIAR LA AI
		minion:SetAttribute("AIStarted", true)
		minionsWithAI[minion] = true

		print("ğŸ¤– AttachMinionAI: Iniciando AI para " .. minion.Name)
		MinionAI.Start(minion)

		-- ğŸ”¥ CONECTAR EVENTO DE DESTRUCCIÃ“N PARA LIMPIAR LA TABLA
		minion.Destroying:Connect(function()
			minionsWithAI[minion] = nil
		end)
	end
end

-- ğŸ”¥ LISTENER MEJORADO: Con delay y verificaciÃ³n
local function onChildAdded(child)
	-- Esperar un poco para que los atributos se establezcan
	task.wait(0.2)
	tryAttachAI(child)
end

-- ğŸ”¥ LISTENER PARA NUEVOS MINIONS
game.Workspace.ChildAdded:Connect(onChildAdded)

-- ğŸ”¥ INICIALIZACIÃ“N PARA MINIONS EXISTENTES
task.spawn(function()
	task.wait(2) -- Esperar a que todo se inicialice
	print("ğŸ” AttachMinionAI: Buscando minions existentes...")

	for _, child in ipairs(game.Workspace:GetChildren()) do
		tryAttachAI(child)
	end

	print("âœ… AttachMinionAI: InicializaciÃ³n completada")
end)

-- ğŸ”¥ FUNCIÃ“N DE DEBUG
game.Players.PlayerAdded:Connect(function(player)
	player.Chatted:Connect(function(message)
		if message:lower() == "/aiattachstatus" then
			local count = 0
			for _ in pairs(minionsWithAI) do
				count += 1
			end
			print("ğŸ“Š AttachMinionAI Status: " .. count .. " minions con AI activa")
		end
	end)
end)

print("âœ… AttachMinionAI iniciado - Sistema anti-duplicaciÃ³n activado")